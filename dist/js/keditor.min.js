/**!
 * KEditor - Kademi content editor
 * @copyright: Kademi (http://kademi.co)
 * @author: Kademi (http://kademi.co)
 * @version: 2.0.0
 * @dependencies: $, $.fn.sortable, Bootstrap (optional), FontAwesome (optional)
 */
"use strict";var _generateId=_interopRequireDefault(require("./utils/generateId")),_log=_interopRequireDefault(require("./utils/log"));function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance")}function _iterableToArray(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e)){for(var t=0,n=new Array(e.length);t<e.length;t++)n[t]=e[t];return n}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function _createClass(e,t,n){return t&&_defineProperties(e.prototype,t),n&&_defineProperties(e,n),e}!function(s,v){var h=function(){o.debug&&_log.default.apply(void 0,arguments)},r=function(e){throw new Error("[ KEditor ] ".concat(e))};v.fn.sortable||r("$.fn.sortable does not exist. Please import $.fn.sortable into your document for continue using KEditor.");var c={nestedContainerEnabled:!0,explicitSnippetEnabled:!1,containerForQuickAddComponent:'\n            <div class="row">\n                <div class="col-sm-12" data-type="container-content">\n                </div>\n            </div>\n        ',btnAddContentText:'<i class="fa fa-plus"></i>',btnAddContainerText:'<i class="fa fa-plus"></i> <i class="fa fa-fw fa-columns"></i>',btnAddSubContainerText:'<i class="fa fa-plus"></i> <i class="fa fa-fw fa-columns"></i>',btnAddComponentText:'<i class="fa fa-plus"></i> <i class="fa fa-fw fa-list-ul"></i>',btnMoveContainerText:'<i class="fa fa-sort"></i>',btnMoveComponentText:'<i class="fa fa-arrows"></i>',btnSettingContainerText:'<i class="fa fa-cog"></i>',btnSettingComponentText:'<i class="fa fa-cog"></i>',btnDuplicateContainerText:'<i class="fa fa-files-o"></i>',btnDuplicateComponentText:'<i class="fa fa-files-o"></i>',btnDeleteContainerText:'<i class="fa fa-times"></i>',btnDeleteComponentText:'<i class="fa fa-times"></i>',confirmDeleteContainerText:"Are you sure that you want to delete this container? This action can not be undone!",confirmDeleteComponentText:"Are you sure that you want to delete this component? This action can not be undone!",defaultComponentType:"blank",snippetsUrl:"snippets/snippets.html",snippetsFilterEnabled:!0,snippetsCategoriesSeparator:";",iframeMode:!1,contentStyles:[],contentAreasSelector:null,contentAreasWrapper:'<div class="keditor-ui keditor-content-areas-wrapper"></div>',containerSettingEnabled:!1,containerSettingInitFunction:null,containerSettingShowFunction:null,containerSettingHideFunction:null,onReady:function(){},onSnippetsLoaded:function(e){},onSnippetsError:function(e,t){},onInitIframe:function(e,t,n){},onContentChanged:function(e,t){},onBeforeInitContentArea:function(e){},onInitContentArea:function(e){},onBeforeInitContainer:function(e,t){},onInitContainer:function(e,t){},onBeforeContainerDeleted:function(e,t,n){},onContainerDeleted:function(e,t,n){},onContainerChanged:function(e,t,n){},onContainerDuplicated:function(e,t,n,o){},onContainerSelected:function(e,t,n){},onContainerSnippetAdded:function(e,t,n,o){},onComponentReady:function(e){},onBeforeInitComponent:function(e,t){},onInitComponent:function(e,t){},onBeforeComponentDeleted:function(e,t,n){},onComponentDeleted:function(e,t,n){},onComponentChanged:function(e,t,n){},onComponentDuplicated:function(e,t,n,o){},onComponentSelected:function(e,t,n){},onComponentSnippetAdded:function(e,t,n,o){},onBeforeDynamicContentLoad:function(e,t,n){},onDynamicContentLoaded:function(e,t,n,o,i){},onDynamicContentError:function(e,t,n,o,i){}},d=0,l=1,p=2,f=3,m=4,C=5,b=0,g=1,y=2,o=function(){function u(e,t){_classCallCheck(this,u);var n=this,o=n.element=e,i=n.options=v.extend({},c,t);if(i.iframeMode)n.initIframe();else{n.window=s,n.body=v(document.body);var a=o.val()||o.html()||"",r=n.generateContentAreasWrapper(a);o.is("textarea")?(o.after(r),o.addClass("keditor-hidden-element")):o.empty().append(r),n.contentAreasWrapper=r}n.initSidebar(),n.initSnippetsModal(),n.initContentAreas(),n.body.hasClass("keditor-clicks-initialized")||n.initKEditorClicks(),n.id=n.generateId(),u.instances[n.id]=n,"function"==typeof i.onReady&&i.onReady.call(n)}return _createClass(u,[{key:"generateId",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"",t=(new Date).getTime(),n=Math.round(9876543210*Math.random());return"keditor-".concat(e,"-").concat(t).concat(n)}},{key:"generateContentAreasWrapper",value:function(e){var t=this.options,n=v(t.contentAreasWrapper||"<div />");return n.attr("class","keditor-ui keditor-content-area-wrapper"),n.attr("id")||n.attr("id",this.generateId("content-area-wrapper")),n.html(e),n}},{key:"generateToolbar",value:function(e,t){var n=this.options,o="";if(!n.explicitSnippetEnabled){switch(e){case d:"keditor-content-area-toolbar";case f:case m:return'\n                            <div class="keditor-ui '.concat("keditor-container-content-toolbar",'">\n                                <a href="javascript:void(0)" class="keditor-ui keditor-btn keditor-btn-default btn-add-content" title="Add content">').concat(n.btnAddContentText,"</a>\n                            </div>\n                        ")}}switch(e){case d:return'\n                        <div class="keditor-ui keditor-content-area-toolbar">\n                            <a href="javascript:void(0)" class="keditor-ui keditor-btn keditor-btn-default btn-add-container" title="Add container">'.concat(n.btnAddContainerText,"</a>\n                        </div>\n                    ");case l:return!0===n.containerSettingEnabled&&(o='<a href="javascript:void(0);" class="keditor-ui btn-container-setting">'.concat(n.btnSettingContainerText,"</a>")),'\n                        <div class="keditor-toolbar keditor-toolbar-container">\n                            <a href="javascript:void(0);" class="keditor-ui btn-container-reposition">'.concat(n.btnMoveContainerText,"</a>\n                            ").concat(o,'\n                            <a href="javascript:void(0);" class="keditor-ui btn-container-duplicate">').concat(n.btnDuplicateContainerText,'</a>\n                            <a href="javascript:void(0);" class="keditor-ui btn-container-delete">').concat(n.btnDeleteContainerText,"</a>\n                        </div>\n                    ");case p:return!0===n.containerSettingEnabled&&(o='<a href="javascript:void(0);" class="keditor-ui btn-container-setting">'.concat(n.btnSettingContainerText,"</a>")),'\n                        <div class="keditor-toolbar keditor-toolbar-container keditor-toolbar-sub-container">\n                            <a href="javascript:void(0);" class="keditor-ui btn-container-reposition">'.concat(n.btnMoveContainerText,"</a>\n                            ").concat(o,'\n                            <a href="javascript:void(0);" class="keditor-ui btn-container-duplicate">').concat(n.btnDuplicateContainerText,'</a>\n                            <a href="javascript:void(0);" class="keditor-ui btn-container-delete">').concat(n.btnDeleteContainerText,"</a>\n                        </div>\n                    ");case f:return'\n                        <div class="keditor-ui keditor-container-content-toolbar keditor-btn-group">\n                            <a href="javascript:void(0)" class="keditor-ui keditor-btn keditor-btn-default btn-add-container" title="Add sub-container">'.concat(n.btnAddSubContainerText,'</a>\n                            <a href="javascript:void(0)" class="keditor-ui keditor-btn keditor-btn-default btn-add-component" title="Add component">').concat(n.btnAddComponentText,"</a>\n                        </div>\n                    ");case m:return'\n                        <div class="keditor-ui keditor-container-content-toolbar">\n                            <a href="javascript:void(0)" class="keditor-ui keditor-btn keditor-btn-default btn-add-component" title="Add component">'.concat(n.btnAddComponentText,"</a>\n                        </div>\n                    ");case C:return t&&(o='<a href="javascript:void(0);" class="keditor-ui btn-component-setting">'.concat(n.btnSettingComponentText,"</a>")),'\n                        <div class="keditor-toolbar keditor-toolbar-component">\n                            <a href="javascript:void(0);" class="keditor-ui btn-component-reposition">'.concat(n.btnMoveComponentText,"</a>\n                            ").concat(o,'\n                            <a href="javascript:void(0);" class="keditor-ui btn-component-duplicate">').concat(n.btnDuplicateComponentText,'</a>\n                            <a href="javascript:void(0);" class="keditor-ui btn-component-delete">').concat(n.btnDeleteComponentText,"</a>\n                        </div>\n                    ")}}},{key:"beautifyCategories",value:function(e){for(var t=[],n=0;n<e.length;n++){var o=e[n]||"";""!==o&&-1===v.inArray(o,t)&&t.push(o)}return t.sort()}},{key:"setSettingContainer",value:function(e){this.settingContainer=e}},{key:"getSettingContainer",value:function(){return this.settingContainer}},{key:"setSettingComponent",value:function(e){this.settingComponent=e}},{key:"getSettingComponent",value:function(){return this.settingComponent}},{key:"getDataAttributes",value:function(e,n,o){var i=o?[]:{};return n||(n=[]),v.each(e.get(0).attributes,function(e,t){0===t.name.indexOf("data-")&&-1===v.inArray(t.name,n)&&(o?i.push("".concat(t.name,'="').concat(t.value,'"')):i[t.name]=t.value)}),i}},{key:"getComponentType",value:function(e){var t=this.options,n=(e.attr("data-type")||"").replace("component-","");return n&&n in u.components||("string"==typeof t.defaultComponentType?n=t.defaultComponentType:"function"==typeof t.defaultComponentType&&(n=t.defaultComponentType.call(this,e)),n||r("Component type is undefined!"),h("Fallback to defaultComponentType: ".concat(n))),n}},{key:"getClickedElement",value:function(e,t){var n=v(e.target),o=n.closest(t);return n.is(t)?n:0<o.length?o:null}},{key:"initIframe",value:function(){h("initIframe");var e=this,t=e.options,n=e.element,o=n.is("textarea")?n.val():n.html(),i=e.iframeWrapper=v('<div class="keditor-ui keditor-iframe-wrapper"></div>'),a=e.iframe=v('<iframe class="keditor-ui keditor-iframe"></iframe>');n.after(i),i.attr("id",e.generateId("iframe-wrapper")).append(a),n.addClass("keditor-hidden-element");var r=e.iframeDoc=a.contents();r.get(0).open(),r.get(0).close(),e.window=a[0].contentWindow?a[0].contentWindow:a[0].contentDocument.defaultView;var s=e.iframeHead=r.find("head"),c=e.iframeBody=e.body=r.find("body");h("Adding styles to iframe...");var d="";v('[data-type="keditor-style"]').each(function(){var e=v(this),t=e.attr("href")||e.attr("data-href")||"";d+=t?'<link rel="stylesheet" type="text/css" href="'.concat(t,'" />\n'):'<style type="text/css">'.concat(e.html(),"</style>\n")}),t.contentStyles&&v.isArray(t.contentStyles)&&v.each(t.contentStyles,function(e,t){var n="";t.id&&(n=' id="'.concat(t.id,'" ')),t.href?d+='<link rel="stylesheet" type="text/css" href="'.concat(t.href,'" ').concat(n," />\n"):d+='<style type="text/css" '.concat(n,">").concat(t.content,"</style>\n")}),s.append(d),h("Adding original content to iframe...");var l=e.generateContentAreasWrapper(o);c.append(l),e.contentAreasWrapper=l,"function"==typeof t.onInitIframe&&t.onInitIframe.call(e,a,s,c)}},{key:"initKEditorClicks",value:function(){h("initKEditorClicks");var s=this,c=s.options,d=s.body;d.on("click",function(e){var t=s.getClickedElement(e,".keditor-sidebar"),n=s.getClickedElement(e,".keditor-modal"),o=s.getClickedElement(e,".keditor-container");if(o){if(!o.hasClass("showed-keditor-toolbar")){d.find(".keditor-container.showed-keditor-toolbar").removeClass("showed-keditor-toolbar"),d.find(".keditor-component.showed-keditor-toolbar").removeClass("showed-keditor-toolbar"),o.addClass("showed-keditor-toolbar");var i=o.parent();"function"==typeof c.onContainerSelected&&c.onContainerSelected.call(s,e,o,i)}}else t||n||(d.find(".keditor-container.showed-keditor-toolbar").removeClass("showed-keditor-toolbar"),d.find(".keditor-component.showed-keditor-toolbar").removeClass("showed-keditor-toolbar"));var a=s.getClickedElement(e,".keditor-component");if(a){if(!a.hasClass("showed-keditor-toolbar")){d.find(".keditor-component.showed-keditor-toolbar").removeClass("showed-keditor-toolbar"),a.addClass("showed-keditor-toolbar");var r=a.parent();"function"==typeof c.onComponentSelected&&c.onComponentSelected.call(s,e,a,r)}}else t||d.find(".keditor-component.showed-keditor-toolbar").removeClass("showed-keditor-toolbar")}),d.on("click",".btn-container-setting",function(e){e.preventDefault();var t=v(this);h("Click on .btn-container-setting",t);var n=t.closest(".keditor-container");d.hasClass("opened-keditor-setting")&&d.hasClass("opened-keditor-sidebar")&&n.is(s.settingContainer)?s.closeSidebar():s.openSidebar(n)}),d.on("click",".btn-container-duplicate",function(e){e.preventDefault();var t=v(this);h("Click on .btn-container-duplicate",t);var n=t.closest(".keditor-container"),o=n.parent(),i=v(s.getContainerContent(n,t.parent().hasClass("keditor-toolbar-sub-container")));n.after(i),s.convertToContainer(o,i),h("Container is duplicated"),"function"==typeof c.onContainerDuplicated&&c.onContainerDuplicated.call(s,n,i,o),"function"==typeof c.onContentChanged&&c.onContentChanged.call(s,e,o)}),d.on("click",".btn-container-delete",function(e){e.preventDefault();var t=v(this);if(h("Click on .btn-container-delete",t),confirm(c.confirmDeleteContainerText)){var n=t.closest(".keditor-container"),o=n.find(".keditor-component"),i=n.parent();"function"==typeof c.onBeforeContainerDeleted&&c.onBeforeContainerDeleted.call(s,e,n,i);var a=s.settingComponent;if(a)a.closest(".keditor-container").is(n)&&(h("Deleting container is container of setting container. Close setting panel for this setting component",a),s.closeSidebar());else n.is(s.settingContainer)&&(h("Deleting container is setting container. Close setting panel for this container",n),s.closeSidebar());0<o.length&&o.each(function(){s.deleteComponent(v(this))}),n.remove(),"function"==typeof c.onContainerDeleted&&c.onContainerDeleted.call(s,e,n,i),"function"==typeof c.onContentChanged&&c.onContentChanged.call(s,e,i)}}),d.on("click",".btn-component-setting",function(e){e.preventDefault();var t=v(this);h("Click on .btn-component-setting",t);var n=t.closest(".keditor-component");d.hasClass("opened-keditor-setting")&&d.hasClass("opened-keditor-sidebar")&&n.is(s.settingComponent())?s.closeSidebar():s.openSidebar(n)}),d.on("click",".btn-component-duplicate",function(e){e.preventDefault();var t=v(this);h("Click on .btn-component-duplicate",t);var n=t.closest(".keditor-component"),o=n.closest(".keditor-container"),i=o.parent(),a=v(s.getComponentContent(n));n.after(a),s.convertToComponent(i,o,a),h("Component is duplicated"),"function"==typeof c.onComponentDuplicated&&c.onComponentDuplicated.call(s,n,a,i),"function"==typeof c.onContainerChanged&&c.onContainerChanged.call(s,e,o,i),"function"==typeof c.onContentChanged&&c.onContentChanged.call(s,e,i)}),d.on("click",".btn-component-delete",function(e){e.preventDefault();var t=v(this);if(h("Click on .btn-component-delete",t),confirm(c.confirmDeleteComponentText)){var n=t.closest(".keditor-component"),o=n.closest(".keditor-container"),i=n.closest(".keditor-content-area");"function"==typeof c.onBeforeComponentDeleted&&c.onBeforeComponentDeleted.call(s,e,n,i),n.is(s.settingComponent)&&s.closeSidebar(),s.deleteComponent(n),"function"==typeof c.onComponentDeleted&&c.onComponentDeleted.call(s,e,n,i),"function"==typeof c.onContainerChanged&&c.onContainerChanged.call(s,e,o,i),"function"==typeof c.onContentChanged&&c.onContentChanged.call(s,e,i)}}),d.addClass("keditor-clicks-initialized")}},{key:"initSidebar",value:function(){var t=this,e=t.options,n=t.generateId("sidebar"),o=t.sidebar=v('\n                <div class="keditor-ui keditor-sidebar" id="'.concat(n,'">                    \n                    <div class="keditor-ui keditor-sidebar-header">\n                        <span class="keditor-ui keditor-sidebar-title"></span>\n                        <a href="javascript:void(0);" class="keditor-ui keditor-sidebar-close">&times;</a>\n                    </div>\n                    <div class="keditor-ui keditor-sidebar-body"></div>\n                </div>\n            '));o.find(".keditor-sidebar-close").on("click",function(e){e.preventDefault(),t.closeSidebar()});var i=o.find(".keditor-sidebar-body");if(i.on("submit","form",function(e){return e.preventDefault(),!1}),!0===e.containerSettingEnabled)if("function"==typeof e.containerSettingInitFunction){var a=v('<div  class="keditor-ui keditor-setting-form keditor-container-setting"></div>');i.append(a),h("Initialize container setting panel"),e.containerSettingInitFunction.call(t,a,t)}else r('"containerSettingInitFunction" is not function!');o.appendTo(e.iframeMode?t.iframeWrapper:t.body)}},{key:"openSidebar",value:function(e){var t=this,n=t.options,o=t.sidebar,i=o.find(".keditor-sidebar-title"),a=o.find(".keditor-sidebar-body");if(a.children(".active").removeClass("active"),e.is(".keditor-component")){t.setSettingComponent(e),t.setSettingContainer(null);var r=t.getComponentType(e),s=u.components[r];i.html(s.settingTitle);var c=a.find(".keditor-setting-".concat(r));if(0===c.length){var d=u.components[r];if("function"==typeof d.initSettingForm){c=v('\n                            <div \n                                data-type="'.concat(r,'" \n                                class="keditor-ui keditor-setting-form keditor-setting-').concat(r,' clearfix active"\n                            >\n                            </div>\n                        '));var l=v("<span />").html("Loading...");a.append(c),c.append(l);var p=d.initSettingForm.call(d,c,t);v.when(p).done(function(){h('Initialized setting form for component type "'.concat(r,'"')),setTimeout(function(){l.remove(),"function"==typeof d.showSettingForm&&d.showSettingForm.call(d,c,e,t)},100)})}}else"function"==typeof s.showSettingForm&&s.showSettingForm.call(s,c,e,t),c.addClass("active")}else{t.setSettingContainer(e),t.setSettingComponent(null),i.html("Container Settings");var f=o.find(".keditor-container-setting");"function"==typeof n.containerSettingShowFunction&&n.containerSettingShowFunction.call(t,f,e,t),f.addClass("active")}o.addClass("opened")}},{key:"closeSidebar",value:function(){var e=this,t=e.options,n=e.sidebar,o=n.find(".keditor-sidebar-body").children(".active");if(0<o.length){if(o.is(".keditor-container-setting"))"function"==typeof t.containerSettingHideFunction&&t.containerSettingHideFunction.call(e,o,e);else{var i=o.attr("data-type"),a=u.components[i];"function"==typeof a.hideSettingForm&&a.hideSettingForm.call(a,o,e)}o.removeClass("active")}e.setSettingComponent(null),e.setSettingContainer(null),n.removeClass("opened")}},{key:"showSettingPanel",value:function(e){this.openSidebar(e)}},{key:"hideSettingPanel",value:function(){this.closeSidebar()}},{key:"initSnippetsModal",value:function(){var m=this,C=m.options,e=m.generateId("modal"),t="";t=C.explicitSnippetEnabled?'\n                    <div class="keditor-snippets-wrapper keditor-snippets-wrapper-container">\n                        <div class="keditor-snippets keditor-snippets-container"></div>\n                    </div>\n                    <div class="keditor-snippets-wrapper keditor-snippets-wrapper-component">\n                        <div class="keditor-snippets keditor-snippets-component"></div>\n                    </div>\n                ':'\n                    <div class="keditor-snippets-wrapper">\n                        <div class="keditor-snippets"></div>\n                    </div>\n                ';var k=m.modal=v('\n                <div class="keditor-ui keditor-modal" id="'.concat(e,'">\n                    <div class="keditor-modal-header">\n                        <button type="button" class="keditor-modal-close">&times;</button>\n                        <h4 class="keditor-modal-title"></h4>\n                    </div>\n                    <div class="keditor-modal-body">').concat(t,'</div>\n                    <div class="keditor-modal-footer">\n                        <button type="button" class="keditor-ui keditor-btn keditor-btn-default keditor-modal-close">Close</button>\n                        <button type="button" class="keditor-ui keditor-btn keditor-btn-primary keditor-modal-add">Add</button>\n                    </div>\n                </div>\n            '));if("string"==typeof C.snippetsUrl&&0<C.snippetsUrl.length){h('Getting snippets form "'.concat(C.snippetsUrl,'"...')),v.ajax({type:"get",dataType:"html",url:C.snippetsUrl,success:function(e){h("Success in getting snippets"),"function"==typeof C.onSnippetsLoaded&&(e=C.onSnippetsLoaded.call(m,e)||e),m.renderSnippets(e),C.snippetsFilterEnabled&&(C.explicitSnippetEnabled?(m.initSnippetsFilter(g),m.initSnippetsFilter(y)):m.initSnippetsFilter(b))},error:function(e){h("Error when getting snippets",e),"function"==typeof C.onSnippetsError&&C.onSnippetsError.call(m,e)}}),k.find(".keditor-modal-close").on("click",function(e){e.preventDefault(),m.closeModal()}),k.find(".keditor-modal-add").on("click",function(e){e.preventDefault();var t=k.find(".keditor-snippets-wrapper .selected");if(0!==t.length){var n,o,i=m.modalTarget.closest(".keditor-content-area"),a=t.attr("data-type"),r=k.find(t.attr("data-snippet")),s=r.html(),c=!1,d=!1,l=!1;if(C.explicitSnippetEnabled)switch(m.modalSnippetType){case y:d=!0;break;case g:c=!0}else if("container"===a)c=!0;else switch(m.modalSnippetType){case y:d=!0;break;case b:m.modalTarget.is(".keditor-container-content-inner")?d=!0:l=!0}if(c&&(m.body.find(".keditor-container.showed-keditor-toolbar").removeClass("showed-keditor-toolbar"),n=v('\n                            <section class="keditor-ui keditor-container showed-keditor-toolbar">\n                                <section class="keditor-ui keditor-container-inner">'.concat(s,"</section>\n                            </section>\n                        ")),m.modalTarget.append(n),"function"==typeof C.onContainerSnippetAdded&&C.onContainerSnippetAdded.call(m,e,n,t,i),"function"==typeof C.onContentChanged&&C.onContentChanged.call(m,e,i),m.initContainer(i,n)),d){var p=m.getDataAttributes(r,null,!0);o=v('\n                            <section class="keditor-ui keditor-component" data-type="'.concat(a,'" ').concat(p.join(" "),'>\n                                <section class="keditor-ui keditor-component-content">').concat(s,"</section>\n                            </section>\n                        ")),m.modalTarget.append(o);var f=m.modalTarget.closest(".keditor-container");"function"==typeof C.onComponentSnippetAdded&&C.onComponentSnippetAdded.call(m,e,o,t,i),"function"==typeof C.onContentChanged&&C.onContentChanged.call(m,e,i),m.initComponent(i,f,o)}if(l){m.body.find(".keditor-container.showed-keditor-toolbar").removeClass("showed-keditor-toolbar");var u=m.getDataAttributes(r,null,!0);n=v('\n                            <section class="keditor-ui keditor-container showed-keditor-toolbar">\n                                <section class="keditor-ui keditor-container-inner">'.concat(C.containerForQuickAddComponent,"</section>\n                            </section>\n                        ")),o=v('\n                            <section class="keditor-ui keditor-component" data-type="'.concat(a,'" ').concat(u.join(" "),'>\n                                <section class="keditor-ui keditor-component-content">').concat(s,"</section>\n                            </section>\n                        ")),n.find('[data-type="container-content"]').eq(0).html(o),m.modalTarget.append(n),"function"==typeof C.onComponentSnippetAdded&&C.onComponentSnippetAdded.call(m,e,o,t,i),"function"==typeof C.onContentChanged&&C.onContentChanged.call(m,e,i),m.initContainer(i,n)}m.closeModal()}}),k.on("click",".keditor-snippet",function(e){e.preventDefault();var t=v(this);t.hasClass("selected")||(t.parent().find(".selected").removeClass("selected"),t.addClass("selected"))});k.on("webkitTransitionEnd otransitionend oTransitionEnd msTransitionEnd transitionend",function(){k.hasClass("showed")||(k.css("display","none"),v(document.body).removeClass("opened-modal"))}),k.appendTo(document.body)}else r('"snippetsUrl" must be not null!')}},{key:"renderSnippets",value:function(e){h("renderSnippets");var l=this,p=l.options,f="",u="",m="";l.snippetsCategories=[],l.snippetsContainerCategories=[],l.snippetsComponentCategories=[],v(e).filter("div").each(function(e){var t=v(this),n=l.generateId("snippet"),o=t.html().trim(),i=t.attr("data-preview"),a=t.attr("data-type"),r=t.attr("data-keditor-title"),s=t.attr("data-keditor-categories")||"",c='\n                    <section\n                        class="keditor-ui keditor-snippet"\n                        data-snippet="#'.concat(n,'"\n                        data-type="').concat(a,'"\n                        title="').concat(r,'"\n                        data-keditor-categories="').concat(s,'"\n                    >\n                        <span><span style="background-image: url(\'').concat(i,"')\"></span></span>   \n                    </section>\n                ");s=s.split(p.snippetsCategoriesSeparator),"container"===a?(f+=c,l.snippetsContainerCategories=l.snippetsContainerCategories.concat(s)):-1!==a.indexOf("component")&&(u+=c,l.snippetsComponentCategories=l.snippetsComponentCategories.concat(s));var d=l.getDataAttributes(t,["data-preview","data-type","data-keditor-title","data-keditor-categories"],!0);m+='<script id="'.concat(n,'" type="text/html" ').concat(d.join(" "),">").concat(o,"<\/script>")}),l.snippetsContainerCategories=l.beautifyCategories(l.snippetsContainerCategories),l.snippetsComponentCategories=l.beautifyCategories(l.snippetsComponentCategories),l.snippetsCategories=l.beautifyCategories([].concat(_toConsumableArray(l.snippetsContainerCategories),_toConsumableArray(l.snippetsComponentCategories))),p.explicitSnippetEnabled?(l.modal.find(".keditor-snippets-container").html(f),l.modal.find(".keditor-snippets-component").html(u)):l.modal.find(".keditor-snippets").html(f+u),l.modal.find(".keditor-modal-body").append(m)}},{key:"initSnippetsFilter",value:function(e){h("initSnippetsFilter");var t,n,o=this,i=o.options,a=o.modal;switch(e){case b:t=o.snippetsCategories,n=".keditor-snippets-wrapper";break;case g:t=o.snippetsContainerCategories,n=".keditor-snippets-wrapper-container";break;case y:t=o.snippetsComponentCategories,n=".keditor-snippets-wrapper-component"}var r="";v.each(t,function(e,t){r+='<option value="'.concat(t,'">').concat(t,"</option>")});var s=a.find(n),c=s.find(".keditor-snippets").children(".keditor-snippet");s.prepend('\n                <div class="keditor-ui keditor-snippets-filter-wrapper">\n                    <select class="keditor-ui keditor-snippets-filter">\n                        <option value="" selected="selected">All</option>\n                        '.concat(r,'\n                    </select>\n                    <input type="text" class="keditor-ui keditor-snippets-search" value="" placeholder="Type to search..." />\n                </div>                \n            ')),c.each(function(){var e=v(this),t=e.attr("data-keditor-categories")||"",n=t.toLowerCase();t=t.split(i.snippetsCategoriesSeparator),n=n.split(i.snippetsCategoriesSeparator),e.data("categories",t),e.data("categoriesFilter",n)});var d,l=s.find(".keditor-snippets-search"),p=s.find(".keditor-snippets-filter"),f=function(){var i=(p.val()||"").toLowerCase(),a=(l.val()||"").toLowerCase();c.filter(".selected").removeClass("selected"),i||a?(h("Filtering snippets"),c.each(function(){var e=v(this),t=e.data("categoriesFilter"),n=t.join(";"),o=0;(i&&-1===v.inArray(i,t)&&o++,a)&&(-1===e.attr("title").toLowerCase().indexOf(a)&&-1===n.indexOf(a)&&o++);e[0===o?"removeClass":"addClass"]("not-matched")})):(h("Show all snippets"),c.removeClass("not-matched"))};p.on("change",function(){f()}),l.on("keydown",function(){clearTimeout(d),d=setTimeout(f,200)})}},{key:"openModal",value:function(e,t){h("openModal",e,t);var n=this.modal,o=this.options,i="";switch(t){case g:i="Add container";break;case y:i="Add component"}o.explicitSnippetEnabled?(n.find(".keditor-snippets-wrapper").css("display","none"),n.find(t===y?".keditor-snippets-wrapper-component":".keditor-snippets-wrapper-container").css("display","block")):(n.find(".keditor-snippets-wrapper").css("display","block").find(".keditor-snippet[data-type=container]").css("display",t===y?"none":"block"),i="Add content"),n.find(".keditor-modal-title").html(i),this.modalTarget=e,this.modalSnippetType=t,n.css("display","block"),v(document.body).addClass("opened-modal"),setTimeout(function(){n.addClass("showed")},0)}},{key:"closeModal",value:function(){var e=this.modal;this.modalTarget=null,this.modalAction=null,e.find(".keditor-modal-title").html(""),e.find(".keditor-snippets-wrapper .selected").removeClass("selected"),e.removeClass("showed")}},{key:"initContentAreas",value:function(){h("initContentAreas");var e,t=this,n=t.contentAreasWrapper,o=t.options;if(o.contentAreasSelector&&(e=n.find(o.contentAreasSelector)),!e||0===e.length){h("Do not find any content area. Creating default content area...");var i=n.html();e=v("<div />").html(i),n.empty().append(e)}e.each(function(){var e=v(this);e.attr("id")||e.attr("id",t.generateId("content-area")),t.initContentArea(e)})}},{key:"initContentArea",value:function(i,e){h("initContentArea",i);var a=this,r=a.options;i.addClass("keditor-content-area");var t=i.html(),n=v('<div class="keditor-content-area-inner"></div>').html(t);if(i.html(n),"function"==typeof r.onBeforeInitContentArea&&r.onBeforeInitContentArea.call(a,i),!e){var o=v(a.generateToolbar(d));i.append(o),o.children(r.explicitSnippetEnabled?".btn-add-container":".btn-add-content").on("click",function(e){e.preventDefault(),a.openModal(n,r.explicitSnippetEnabled?g:b)})}if(h("Initialize $.fn.sortable for content area"),n.sortable({handle:".keditor-toolbar-container:not(.keditor-toolbar-sub-container) .btn-container-reposition",items:"> section",helper:"clone",connectWith:".keditor-content-area",axis:"y",tolerance:"pointer",sort:function(){v(this).removeClass("ui-state-default")},receive:function(e,t){h("On received snippet",e,t);var n=t.helper,o=t.item;n&&n.remove(),a.closeSidebar(),"function"==typeof r.onContentChanged&&r.onContentChanged.call(a,e,i),o.addClass("keditor-ui-dragging")},start:function(e,t){t.item.addClass("keditor-ui-dragging")},stop:function(e,t){t.helper&&t.helper.remove(),t.item.removeClass("keditor-ui-dragging")}}),h("Initialize existing containers in content area"),n.children("section").each(function(){a.convertToContainer(i,v(this))}),"function"==typeof r.onInitContentArea){var s=r.onInitContentArea.call(a,i);s&&0<s.length&&v.each(s,function(){a.convertToContainer(i,v(this))})}}},{key:"convertToContainer",value:function(e,t){h("convertToContainer",e,t);var n;n=t.is("section")?(t.addClass("keditor-ui keditor-container"),t.wrapInner('<section class="keditor-ui keditor-container-inner"></section>'),t):(t.wrap('<section class="keditor-ui keditor-container"><section class="keditor-ui keditor-container-inner"></section></section>'),t.parent().parent()),this.initContainer(e,n)}},{key:"initContainer",value:function(t,n){var o=this,i=o.options,a=i.nestedContainerEnabled&&0<n.closest('[data-type="container-content"]').length;if(h("initContainer - isNested=".concat(a),t,n),n.hasClass("keditor-initialized-container")&&n.hasClass("keditor-initializing-container"))n.hasClass("keditor-initialized-container")?h("Container is already initialized!"):h("Container is initializing...");else{n.addClass("keditor-initializing-container"),"function"==typeof i.onBeforeInitContainer&&i.onBeforeInitContainer.call(o,n,t),a&&n.addClass("keditor-sub-container"),h("Render KEditor toolbar for container",n),n.append(o.generateToolbar(a?p:l)),n.attr("id",o.generateId(a?"sub-container":"container"));var e=n.find('[data-type="container-content"]');h("Initialize ".concat(e.length," container content(s)")),e.each(function(){var e=v(this);i.nestedContainerEnabled&&!a&&0<e.parents('[data-type="container-content"]').length||o.initContainerContent(t,n,e,a)}),"function"==typeof i.onInitContainer&&i.onInitContainer.call(o,n,t),n.addClass("keditor-initialized-container"),n.removeClass("keditor-initializing-container")}}},{key:"initContainerContent",value:function(a,t,e,n){h("initContainerContent - isNested=".concat(n),a,t,e);var r=this,s=r.options;e.addClass("keditor-container-content"),n&&e.addClass("keditor-sub-container-content"),e.attr("id",r.generateId("container-content"));var o=v('<div class="keditor-container-content-inner"></div>');o.html(e.html()),e.html(o),h("Initialize toolbar for container content");var i=v(r.generateToolbar(n?m:f));i.appendTo(e),s.explicitSnippetEnabled?(n||s.explicitSnippetEnabled&&i.children(".btn-add-container").on("click",function(e){e.preventDefault(),r.openModal(o,g)}),i.children(".btn-add-component").on("click",function(e){e.preventDefault(),r.openModal(o,y)})):i.children(".btn-add-content").on("click",function(e){e.preventDefault(),r.openModal(o,n?y:s.nestedContainerEnabled?b:y)}),h("Initialize $.fn.sortable for container content"),o.sortable({handle:".btn-component-reposition, .btn-container-reposition",helper:"clone",items:"> section",connectWith:".keditor-container-content-inner",tolerance:"pointer",sort:function(){v(this).removeClass("ui-state-default")},receive:function(e,t){h("On received snippet",e,t);var n,o=t.helper,i=t.item;o&&o.remove(),(n=i.closest(".keditor-container")).hasClass("showed-keditor-toolbar")||(v(".keditor-container.showed-keditor-toolbar").removeClass("showed-keditor-toolbar"),n.addClass("showed-keditor-toolbar")),"function"==typeof s.onContainerChanged&&s.onContainerChanged.call(r,e,n,a),"function"==typeof s.onContentChanged&&s.onContentChanged.call(r,e,a),i.removeClass("keditor-ui-dragging")},start:function(e,t){t.item.addClass("keditor-ui-dragging")},stop:function(e,t){t.helper&&t.helper.remove(),t.item.removeClass("keditor-ui-dragging")}}),h("Initialize existing components inside container content"),o.children().each(function(){var e=v(this);0<e.find('[data-type="container-content"]').length?r.convertToContainer(a,e):r.convertToComponent(a,t,e,!0)})}},{key:"convertToComponent",value:function(e,t,n,o){if(h("convertToComponent",e,t,n,o),!n.is(".keditor-container-content-toolbar")){var i;i=n.is("section")?(n.addClass("keditor-ui keditor-component"),n.wrapInner('<section class="keditor-ui keditor-component-content"></section>'),n):(n.wrap('<section class="keditor-ui keditor-component"><section class="keditor-ui keditor-component-content"></section></section>'),n.parent().parent()),o&&i.addClass("existing-component"),this.initComponent(e,t,i)}}},{key:"initComponent",value:function(e,t,n){h("initComponent",e,t,n);var o=this,i=o.options;o.body;if(n.hasClass("keditor-initialized-component")&&n.hasClass("keditor-initializing-component"))n.hasClass("keditor-initialized-component")?h("Component is already initialized!"):h("Component is initializing...");else{n.addClass("keditor-initializing-component"),n.attr("id",o.generateId("component")),"function"==typeof i.onBeforeInitComponent&&i.onBeforeInitComponent.call(o,n,e),n.children(".keditor-component-content").attr("id",o.generateId("component-content"));var a=o.getComponentType(n);h("Component type: ".concat(a));var r=u.components[a];h("Render KEditor toolbar for component",n),n.append(o.generateToolbar(C,r.settingEnabled)),n.find("[data-dynamic-href]").each(function(){var e=v(this);o.initDynamicContent(e)}),"function"==typeof r.init?r.init.call(r,e,t,n,o):h('"init" function of component type "'.concat(a,'" does not exist')),"function"==typeof i.onInitComponent&&i.onInitComponent.call(o,n,e),n.addClass("keditor-initialized-component"),n.removeClass("keditor-initializing-component")}}},{key:"initDynamicContent",value:function(o){h("initDynamicContent",o);var i=this,a=i.options,e=o.closest(".keditor-component"),r=o.closest(".keditor-content-area");o.attr("id",i.generateId("dynamic-element")),"function"==typeof a.onBeforeDynamicContentLoad&&a.onBeforeDynamicContentLoad.call(i,o,e,r);var t=o.attr("data-dynamic-href"),n=i.getDataAttributes(e,["data-type","data-dynamic-href"],!1);return n=v.param(n),h("Dynamic href: ".concat(t,", Data: ").concat(n)),v.ajax({url:t,data:n,type:"GET",dataType:"HTML",success:function(e,t,n){h("Dynamic content is loaded",o,e,t,n),o.html(e),"function"==typeof a.onDynamicContentLoaded&&a.onDynamicContentLoaded.call(i,o,e,t,n,r)},error:function(e,t,n){h("Error when loading dynamic content",o,e,t,n),"function"==typeof a.onDynamicContentError&&a.onDynamicContentError.call(i,o,e,t,n,r)}})}},{key:"deleteComponent",value:function(e){h("deleteComponent",e);var t=this.getComponentType(e),n=u.components[t];"function"==typeof n.destroy&&n.destroy.call(n,e,this),e.remove()}},{key:"initIframeCover",value:function(e,t){t||(e.wrap('<div class="keditor-iframe-wrapper-fake"></div>'),t=e.parent()),t.addClass("keditor-iframe-wrapper");var n=v('<div class="keditor-iframe-cover"></div>');t.prepend(n),t.on("mouseleave",function(){t.removeClass("hidden-cover")}),n.on("dblclick",function(e){e.preventDefault(),t.addClass("hidden-cover")})}},{key:"getComponentContent",value:function(e){h("getComponentContent");var t,n=e.clone(),o=this.getComponentType(n),i=u.components[o],a=this.getDataAttributes(n,null,!0),r=e.find(".keditor-iframe-wrapper");if(0<r.length){r.find(".keditor-iframe-cover").remove();var s=r.children("iframe");r.hasClass("keditor-iframe-wrapper-fake")?s.unwrap():r.removeClass("keditor-iframe-wrapper")}"function"==typeof i.getContent?t=i.getContent.call(i,n,this):t=n.children(".keditor-component-content").html();return n.html(t).find("[data-dynamic-href]").each(function(){v(this).html("")}),"<section ".concat(a.join(" "),">").concat(n.html(),"</section>")}},{key:"getContainerContent",value:function(e,t){h("getContainerContent - isNested=".concat(t),e);var o=this,n=e.children(".keditor-container-inner").clone();return n.find("[data-type=container-content]").not(t?"":".keditor-sub-container-content").each(function(){var e=v(this);e.removeClass("keditor-container-content keditor-sub-container-content ui-sortable").removeAttr("id");var t=e.children(),n="";t.children().each(function(){var e=v(this);e.is(".keditor-component")?n+=o.getComponentContent(e):e.is(".keditor-sub-container")&&(n+=o.getContainerContent(e,!0))}),e.html(n)}),"<section>".concat(n.html(),"</section>")}},{key:"getContent",value:function(e){var n=this,o=[];return n.contentAreasWrapper.find(".keditor-content-area-inner").each(function(){var t="";v(this).children(".keditor-container").each(function(){var e=v(this);t+=n.getContainerContent(e)}),o.push(t)}),e?o:o.join("\n")}},{key:"setContent",value:function(e,t){var n=this.contentAreasWrapper;t?t.jquery||(t=n.find(t)):t=n.children(".keditor-content-area"),0===t.length&&r("Content area does not exist!"),t.html(e),this.initContentArea(t,!0)}},{key:"destroy",value:function(){var e=this,t=e.element,n=e.id,o=e.getContent(!1);e.options.iframeMode?e.iframeWrapper.remove():e.contentAreasWrapper.remove(),t.is("textarea")?t.val(o):t.html(o),t.removeClass("keditor-hidden-element"),t.data("keditor",null),delete u.instances[n]}}]),u}();v.fn.keditor=function(e){var t=v(this),n=t.data("keditor");return"string"!=typeof e?(n||(n=new o(t,e),t.data("keditor",n)),n):n&&n[e]&&"function"==typeof n[e]?n[e].apply(n,Array.prototype.slice.call(arguments,1)):void 0},(v.fn.keditor.constructor=o).instances={},o.debug=!1,o.version="@{version}",o.components={blank:{settingEnabled:!1}},o.DEFAULTS=c,o.log=h,o.error=r,s.KEditor=v.keditor=o}(window,jQuery);
//# sourceMappingURL=keditor.min.js.map
